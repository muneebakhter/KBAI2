{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "cosmosAccountName": {
            "type": "string",
            "defaultValue": "[concat('kbai-cosmos-', uniqueString(resourceGroup().id))]",
            "maxLength": 44,
            "minLength": 3,
            "metadata": {
                "description": "Name of the Azure Cosmos DB account"
            }
        },
        "databaseName": {
            "type": "string",
            "defaultValue": "kbai-db",
            "metadata": {
                "description": "Name of the Cosmos DB database"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all resources"
            }
        },
        "consistencyLevel": {
            "type": "string",
            "defaultValue": "Session",
            "allowedValues": [
                "Strong",
                "BoundedStaleness",
                "Session",
                "ConsistentPrefix",
                "Eventual"
            ],
            "metadata": {
                "description": "The default consistency level of the Cosmos DB account"
            }
        },
        "maxStalenessPrefix": {
            "type": "int",
            "defaultValue": 100000,
            "maxValue": 2147483647,
            "minValue": 10,
            "metadata": {
                "description": "Max stale requests. Required for BoundedStaleness. Valid ranges, Single Region: 10 to 1000000. Multi Region: 100000 to 1000000."
            }
        },
        "maxIntervalInSeconds": {
            "type": "int",
            "defaultValue": 300,
            "maxValue": 86400,
            "minValue": 5,
            "metadata": {
                "description": "Max lag time (minutes). Required for BoundedStaleness. Valid ranges, Single Region: 5 to 84600. Multi Region: 300 to 86400."
            }
        },
        "enableFreeTier": {
            "type": "bool",
            "defaultValue": false,
            "metadata": {
                "description": "Enable Free Tier for Cosmos DB account (one per subscription)"
            }
        },
        "throughputPolicy": {
            "type": "string",
            "defaultValue": "Autoscale",
            "allowedValues": [
                "Manual",
                "Autoscale"
            ],
            "metadata": {
                "description": "Throughput policy for the database"
            }
        },
        "manualProvisionedThroughput": {
            "type": "int",
            "defaultValue": 400,
            "maxValue": 1000000,
            "minValue": 400,
            "metadata": {
                "description": "Throughput value when using Manual Throughput Policy for the database"
            }
        },
        "autoscaleMaxThroughput": {
            "type": "int",
            "defaultValue": 1000,
            "maxValue": 1000000,
            "minValue": 1000,
            "metadata": {
                "description": "Maximum throughput when using Autoscale Throughput Policy for the database"
            }
        }
    },
    "variables": {
        "cosmosAccountName": "[toLower(parameters('cosmosAccountName'))]",
        "consistencyPolicy": {
            "Eventual": {
                "defaultConsistencyLevel": "Eventual"
            },
            "ConsistentPrefix": {
                "defaultConsistencyLevel": "ConsistentPrefix"
            },
            "Session": {
                "defaultConsistencyLevel": "Session"
            },
            "BoundedStaleness": {
                "defaultConsistencyLevel": "BoundedStaleness",
                "maxStalenessPrefix": "[parameters('maxStalenessPrefix')]",
                "maxIntervalInSeconds": "[parameters('maxIntervalInSeconds')]"
            },
            "Strong": {
                "defaultConsistencyLevel": "Strong"
            }
        },
        "locations": [
            {
                "locationName": "[parameters('location')]",
                "failoverPriority": 0,
                "isZoneRedundant": false
            }
        ],
        "throughputPolicy": {
            "Manual": {
                "throughput": "[parameters('manualProvisionedThroughput')]"
            },
            "Autoscale": {
                "autoscaleSettings": {
                    "maxThroughput": "[parameters('autoscaleMaxThroughput')]"
                }
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.DocumentDB/databaseAccounts",
            "apiVersion": "2021-10-15",
            "name": "[variables('cosmosAccountName')]",
            "location": "[parameters('location')]",
            "properties": {
                "enableFreeTier": "[parameters('enableFreeTier')]",
                "databaseAccountOfferType": "Standard",
                "consistencyPolicy": "[variables('consistencyPolicy')[parameters('consistencyLevel')]]",
                "locations": "[variables('locations')]",
                "enableMultipleWriteLocations": false,
                "enableAutomaticFailover": false,
                "enableAnalyticalStorage": false,
                "capabilities": [
                    {
                        "name": "EnableServerless"
                    }
                ],
                "publicNetworkAccess": "Enabled",
                "enableFreeTier": "[parameters('enableFreeTier')]"
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosAccountName'), '/', parameters('databaseName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosAccountName'))]"
            ],
            "properties": {
                "resource": {
                    "id": "[parameters('databaseName')]"
                },
                "options": "[if(equals(parameters('throughputPolicy'), 'Manual'), variables('throughputPolicy')['Manual'], variables('throughputPolicy')['Autoscale'])]"
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosAccountName'), '/', parameters('databaseName'), '/projects')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosAccountName'), parameters('databaseName'))]"
            ],
            "properties": {
                "resource": {
                    "id": "projects",
                    "partitionKey": {
                        "paths": [
                            "/project_id"
                        ],
                        "kind": "Hash"
                    },
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "includedPaths": [
                            {
                                "path": "/*"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    }
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosAccountName'), '/', parameters('databaseName'), '/faqs')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosAccountName'), parameters('databaseName'))]"
            ],
            "properties": {
                "resource": {
                    "id": "faqs",
                    "partitionKey": {
                        "paths": [
                            "/project_id"
                        ],
                        "kind": "Hash"
                    },
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "includedPaths": [
                            {
                                "path": "/*"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    }
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosAccountName'), '/', parameters('databaseName'), '/kb_entries')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosAccountName'), parameters('databaseName'))]"
            ],
            "properties": {
                "resource": {
                    "id": "kb_entries",
                    "partitionKey": {
                        "paths": [
                            "/project_id"
                        ],
                        "kind": "Hash"
                    },
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "includedPaths": [
                            {
                                "path": "/*"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    }
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosAccountName'), '/', parameters('databaseName'), '/attachments_metadata')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosAccountName'), parameters('databaseName'))]"
            ],
            "properties": {
                "resource": {
                    "id": "attachments_metadata",
                    "partitionKey": {
                        "paths": [
                            "/project_id"
                        ],
                        "kind": "Hash"
                    },
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "includedPaths": [
                            {
                                "path": "/*"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    }
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
            "apiVersion": "2021-10-15",
            "name": "[concat(variables('cosmosAccountName'), '/', parameters('databaseName'), '/index_metadata')]",
            "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmosAccountName'), parameters('databaseName'))]"
            ],
            "properties": {
                "resource": {
                    "id": "index_metadata",
                    "partitionKey": {
                        "paths": [
                            "/project_id"
                        ],
                        "kind": "Hash"
                    },
                    "indexingPolicy": {
                        "indexingMode": "consistent",
                        "includedPaths": [
                            {
                                "path": "/*"
                            }
                        ],
                        "excludedPaths": [
                            {
                                "path": "/\"_etag\"/?"
                            }
                        ]
                    }
                }
            }
        }
    ],
    "outputs": {
        "cosmosAccountName": {
            "type": "string",
            "value": "[variables('cosmosAccountName')]"
        },
        "cosmosEndpoint": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosAccountName')), '2021-10-15').documentEndpoint]"
        },
        "cosmosPrimaryKey": {
            "type": "string",
            "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmosAccountName')), '2021-10-15').primaryMasterKey]"
        },
        "databaseName": {
            "type": "string",
            "value": "[parameters('databaseName')]"
        }
    }
}